<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Application de calcul des baies</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }

    #app {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      text-align: center;
    }

    h2 {
      color: #555;
      margin-top: 20px;
    }

    .section {
      margin-bottom: 30px;
    }

    label {
      display: block;
      margin: 10px 0;
      font-size: 16px;
    }

    input[type="number"],
    textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
    }

    button {
      margin: 10px 0;
      padding: 10px 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #0056b3;
    }

    p {
      margin: 10px 0;
      color: #333;
      white-space: pre-line;
    }

    @media (max-width: 600px) {
      #app {
        padding: 10px;
      }

      h1 {
        font-size: 1.5em;
      }

      h2 {
        font-size: 1.2em;
      }

      label {
        font-size: 14px;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Calcul des baies non protégées et vitrées</h1>
    <div class="section">
      <h2>Onglet Général</h2>
      <label>Surface de la façade (m²) : <input type="number" id="general-facade-surface" value="120" min="0"></label><br>
      <label>Longueur (m) : <input type="number" id="general-length" value="20" min="0"></label><br>
      <label>Hauteur (m) : <input type="number" id="general-height" value="6" min="0"></label><br>
      <label>Distance limitative (m) : <input type="number" id="general-limiting-distance" value="5" min="0"></label><br>
      <button onclick="calculateGeneral()">Calculer</button>
      <p id="general-result"></p>
    </div>
    <div class="section">
      <h2>Onglet Maisons</h2>
      <label>Surface de la façade (m²) : <input type="number" id="houses-facade-surface" value="80" min="0"></label><br>
      <label>Distance limitative (m) : <input type="number" id="houses-limiting-distance" value="3" min="0"></label><br>
      <label>Gicleurs : <input type="checkbox" id="houses-sprinklers"></label><br>
      <label>Baies vitrées (JSON) : <textarea id="houses-openings" rows="3">[{"area": 0.3, "x": 1, "y": 1}, {"area": 0.3, "x": 4, "y": 1}]</textarea></label><br>
      <label>Desservent une seule pièce : <input type="checkbox" id="houses-serves-single-space" checked></label><br>
      <label>Hauteur des murs de séparation (m) : <input type="number" id="houses-adjacent-spaces-height" value="1.5" min="0"></label><br>
      <label>Baies sur le même étage : <input type="checkbox" id="houses-same-floor" checked></label><br>
      <button onclick="calculateHouses()">Calculer</button>
      <p id="houses-result"></p>
    </div>
  </div>

  <script>
    // Module generalCode.js
    const unprotectedOpeningsTable = {
      10: {
        "< 3:1": [0, 8, 10, 18, 29, 46, 91, 100],
        "3:1 à 10:1": [0, 8, 12, 21, 33, 50, 96, 100],
        "> 10:1": [0, 11, 16, 32, 48, 68, 100, 100],
      },
      15: {
        "< 3:1": [0, 7, 9, 14, 22, 33, 63, 100],
        "3:1 à 10:1": [0, 8, 10, 15, 21, 30, 55, 100],
        "> 10:1": [0, 9, 14, 23, 33, 45, 73, 100],
      },
      20: {
        "< 3:1": [0, 7, 9, 12, 18, 26, 48, 81, 100],
        "3:1 à 10:1": [0, 8, 10, 15, 21, 30, 55, 85, 100],
        "> 10:1": [0, 9, 14, 23, 33, 45, 73, 100],
      },
      25: {
        "< 3:1": [0, 7, 8, 11, 16, 23, 41, 66, 98, 100],
        "3:1 à 10:1": [0, 8, 9, 13, 19, 26, 45, 70, 100],
        "> 10:1": [0, 9, 14, 21, 30, 39, 62, 90, 100],
      },
      30: {
        "< 3:1": [0, 7, 8, 11, 15, 20, 32, 56, 83, 100],
        "3:1 à 10:1": [0, 7, 9, 12, 17, 23, 39, 61, 88, 100],
        "> 10:1": [0, 8, 12, 19, 27, 38, 56, 79, 100],
      },
      40: {
        "< 3:1": [0, 7, 8, 10, 13, 17, 28, 44, 64, 89, 100],
        "3:1 à 10:1": [0, 7, 8, 11, 15, 20, 32, 48, 69, 93, 100],
        "> 10:1": [0, 8, 11, 17, 24, 31, 47, 66, 83, 100],
      },
      50: {
        "< 3:1": [0, 7, 8, 10, 14, 18, 28, 41, 57, 77, 100],
        "3:1 à 10:1": [0, 7, 8, 11, 15, 20, 32, 47, 66, 87, 100],
        "> 10:1": [0, 8, 11, 17, 24, 31, 47, 66, 83, 100],
      },
      60: {
        "< 3:1": [0, 7, 8, 9, 11, 14, 21, 32, 45, 62, 81, 100],
        "3:1 à 10:1": [0, 7, 8, 10, 13, 16, 25, 36, 49, 66, 85, 100],
        "> 10:1": [0, 8, 10, 14, 20, 25, 38, 51, 67, 85, 100],
      },
      80: {
        "< 3:1": [0, 7, 7, 8, 10, 12, 18, 26, 36, 48, 62, 79, 98, 100],
        "3:1 à 10:1": [0, 7, 8, 9, 11, 14, 20, 29, 40, 52, 67, 84, 100],
        "> 10:1": [0, 8, 9, 13, 17, 22, 29, 39, 50, 62, 76, 89, 100],
      },
      100: {
        "< 3:1": [0, 7, 7, 8, 9, 11, 16, 22, 30, 40, 51, 65, 80, 97, 100],
        "3:1 à 10:1": [0, 7, 8, 9, 11, 13, 18, 25, 34, 44, 56, 69, 84, 100],
        "> 10:1": [0, 7, 9, 12, 16, 20, 29, 39, 48, 61, 74, 89, 100],
      },
      150: {
        "< 3:1": [0, 7, 7, 8, 9, 10, 13, 17, 22, 29, 37, 46, 56, 67, 79, 93, 100],
        "3:1 à 10:1": [0, 7, 7, 8, 10, 11, 15, 20, 26, 33, 41, 50, 60, 71, 84, 97, 100],
        "> 10:1": [0, 7, 8, 11, 13, 17, 24, 31, 39, 48, 57, 68, 79, 91, 100],
      },
      250: {
        "< 3:1": [0, 7, 7, 7, 8, 9, 10, 13, 16, 20, 25, 30, 36, 43, 51, 59, 68, 87, 100],
        "3:1 à 10:1": [0, 7, 7, 8, 9, 10, 12, 15, 19, 24, 28, 34, 40, 47, 55, 63, 72, 92, 100],
        "> 10:1": [0, 7, 8, 9, 11, 14, 19, 24, 30, 36, 43, 50, 58, 66, 73, 82, 92, 100],
      },
      350: {
        "< 3:1": [0, 7, 7, 7, 8, 8, 9, 11, 14, 16, 20, 24, 27, 32, 37, 42, 48, 64, 81, 99, 100],
        "3:1 à 10:1": [0, 7, 7, 8, 8, 9, 11, 13, 16, 20, 23, 27, 31, 36, 41, 46, 52, 69, 85, 100],
        "> 10:1": [0, 7, 8, 9, 10, 12, 15, 19, 23, 27, 32, 37, 42, 47, 52, 58, 64, 81, 90, 100],
      },
      500: {
        "< 3:1": [0, 7, 7, 7, 7, 8, 9, 10, 12, 14, 16, 19, 22, 25, 29, 33, 37, 47, 58, 71, 100],
        "3:1 à 10:1": [0, 7, 7, 7, 8, 9, 10, 12, 14, 16, 19, 22, 25, 29, 33, 37, 41, 52, 63, 76, 100],
        "> 10:1": [0, 7, 8, 8, 9, 11, 14, 18, 22, 25, 30, 34, 38, 43, 48, 53, 58, 70, 82, 96, 100],
      },
      1000: {
        "< 3:1": [0, 7, 7, 7, 7, 8, 9, 9, 10, 12, 13, 14, 16, 18, 20, 22, 27, 33, 39, 58, 82, 100],
        "3:1 à 10:1": [0, 7, 7, 7, 8, 8, 9, 10, 11, 12, 14, 15, 17, 19, 21, 23, 26, 31, 37, 43, 63, 86, 100],
        "> 10:1": [0, 7, 7, 8, 9, 10, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31, 36, 41, 46, 60, 82, 100],
      },
      2000: {
        "< 3:1": [0, 7, 7, 7, 7, 7, 8, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 20, 23, 27, 37, 49, 63, 79, 97, 100],
        "3:1 à 10:1": [0, 7, 7, 7, 7, 8, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 20, 23, 27, 36, 46, 60, 77, 93, 100],
        "> 10:1": [0, 7, 7, 8, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 21, 23, 25, 27, 32, 36, 40, 53, 66, 82, 99, 100],
      },
    };

    const limitingDistances = [0, 1.2, 1.5, 2.0, 2.5, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 16, 18, 20, 25, 30, 35, 40, 45, 50];
    const facadeSurfaces = [10, 15, 20, 25, 30, 40, 50, 60, 80, 100, 150, 250, 350, 500, 1000, 2000];

    function getRatioCategory(length, height) {
      const ratioLH = length / height;
      const ratioHL = height / length;
      const maxRatio = Math.max(ratioLH, ratioHL);
      if (maxRatio < 3) return "< 3:1";
      if (maxRatio <= 10) return "3:1 à 10:1";
      return "> 10:1";
    }

    function findClosestFacadeSurface(surface) {
      for (let i = facadeSurfaces.length - 1; i >= 0; i--) {
        if (surface >= facadeSurfaces[i]) return facadeSurfaces[i];
      }
      return facadeSurfaces[0];
    }

    function findClosestLimitingDistance(distance) {
      for (let i = limitingDistances.length - 1; i >= 0; i--) {
        if (distance >= limitingDistances[i]) return limitingDistances[i];
      }
      return limitingDistances[0];
    }

    function calculateMaxUnprotectedOpenings(facadeSurface, length, height, limitingDistance) {
      const closestSurface = findClosestFacadeSurface(facadeSurface);
      const closestDistance = findClosestLimitingDistance(limitingDistance);
      const ratioCategory = getRatioCategory(length, height);
      const distanceIndex = limitingDistances.indexOf(closestDistance);
      const percentage = unprotectedOpeningsTable[closestSurface][ratioCategory][distanceIndex];
      return percentage;
    }

    // Module housesCode.js
    const glazedOpeningsTable = {
      30: [0, 7, 9, 12, 39, 88, 100],
      40: [0, 7, 8, 11, 32, 69, 100],
      50: [0, 7, 8, 10, 28, 57, 100],
      100: [0, 7, 8, 9, 18, 34, 56, 84, 100],
      "Plus de 100": [0, 7, 7, 8, 12, 19, 28, 40, 55, 92, 100],
    };

    const limitingDistancesHouses = [0, 1.2, 1.5, 2.0, 4.0, 6.0, 8.0, 10.0, 12.0, 16.0, 20.0, 25.0];
    const facadeSurfacesHouses = [30, 40, 50, 100, "Plus de 100"];

    function findClosestFacadeSurfaceHouses(surface) {
      if (surface > 100) return "Plus de 100";
      for (let i = facadeSurfacesHouses.length - 1; i >= 0; i--) {
        if (surface >= facadeSurfacesHouses[i]) return facadeSurfacesHouses[i];
      }
      return facadeSurfacesHouses[0];
    }

    function findClosestLimitingDistanceHouses(distance) {
      for (let i = limitingDistancesHouses.length - 1; i >= 0; i--) {
        if (distance >= limitingDistancesHouses[i]) return limitingDistancesHouses[i];
      }
      return limitingDistancesHouses[0];
    }

    function calculateMaxGlazedOpenings(facadeSurface, limitingDistance, hasSprinklers) {
      const closestSurface = findClosestFacadeSurfaceHouses(facadeSurface);
      const closestDistance = findClosestLimitingDistanceHouses(limitingDistance);
      const distanceIndex = limitingDistancesHouses.indexOf(closestDistance);
      let percentage = glazedOpeningsTable[closestSurface][distanceIndex];

      if (!hasSprinklers && limitingDistance <= 2) {
        return { percentage, maxAreaPerOpening: 0.35 };
      } else if (!hasSprinklers && limitingDistance > 2) {
        percentage = Math.min(percentage, 50);
      }

      return { percentage, maxAreaPerOpening: null };
    }

    function checkGlazedOpeningsConditions(
      limitingDistance,
      hasSprinklers,
      openings,
      servesSingleSpace,
      adjacentSpacesHeight,
      sameFloor
    ) {
      const errors = [];

      if (!hasSprinklers && limitingDistance <= 2) {
        openings.forEach((opening, index) => {
          if (opening.area > 0.35) {
            errors.push(`L'ouverture ${index + 1} dépasse la surface dégagée maximale de 0,35 m².`);
          }
        });
      }

      if (servesSingleSpace) {
        for (let i = 0; i < openings.length - 1; i++) {
          for (let j = i + 1; j < openings.length; j++) {
            const horizontalDistance = Math.abs(openings[i].x - openings[j].x);
            const verticalDistance = Math.abs(openings[i].y - openings[j].y);
            if (horizontalDistance < 2 && verticalDistance < 2) {
              errors.push(
                `Les ouvertures ${i + 1} et ${j + 1} sont trop proches (distance horizontale ou verticale < 2 m).`
              );
            }
          }
        }
      }

      if (openings.length > 1) {
        if (adjacentSpacesHeight < 1.5) {
          errors.push(
            "Les espaces adjacents doivent avoir un mur de séparation d'au moins 1,5 m de hauteur pour permettre plusieurs baies vitrées."
          );
        }
        if (!sameFloor) {
          errors.push("Les baies vitrées superposées doivent être sur le même étage.");
        }
      }

      return errors;
    }

    // Module app.js
    function handleGeneralTab(facadeSurface, length, height, limitingDistance) {
      const maxPercentage = calculateMaxUnprotectedOpenings(facadeSurface, length, height, limitingDistance);
      return {
        maxUnprotectedOpenings: maxPercentage,
        message: `La surface maximale des baies non protégées est de ${maxPercentage}% (Tableau 3.2.3.1.-B).`,
      };
    }

    function handleHousesTab(
      facadeSurface,
      limitingDistance,
      hasSprinklers,
      openings,
      servesSingleSpace,
      adjacentSpacesHeight,
      sameFloor
    ) {
      const { percentage, maxAreaPerOpening } = calculateMaxGlazedOpenings(
        facadeSurface,
        limitingDistance,
        hasSprinklers
      );
      const errors = checkGlazedOpeningsConditions(
        limitingDistance,
        hasSprinklers,
        openings,
        servesSingleSpace,
        adjacentSpacesHeight,
        sameFloor
      );

      const result = {
        maxGlazedOpenings: percentage,
        maxAreaPerOpening: maxAreaPerOpening || "Aucune restriction",
        message: `La surface maximale des baies vitrées est de ${percentage}% (Tableau 9.10.15.4.).`,
        errors: errors.length > 0 ? errors : null,
      };

      return result;
    }

    // Fonctions pour l'interface utilisateur
    function calculateGeneral() {
      const facadeSurface = parseFloat(document.getElementById('general-facade-surface').value);
      const length = parseFloat(document.getElementById('general-length').value);
      const height = parseFloat(document.getElementById('general-height').value);
      const limitingDistance = parseFloat(document.getElementById('general-limiting-distance').value);

      if (isNaN(facadeSurface) || isNaN(length) || isNaN(height) || isNaN(limitingDistance)) {
        document.getElementById('general-result').innerText = "Erreur : Veuillez entrer des valeurs numériques valides.";
        return;
      }

      const result = handleGeneralTab(facadeSurface, length, height, limitingDistance);
      document.getElementById('general-result').innerText = result.message;
    }

    function calculateHouses() {
      const facadeSurface = parseFloat(document.getElementById('houses-facade-surface').value);
      const limitingDistance = parseFloat(document.getElementById('houses-limiting-distance').value);
      const hasSprinklers = document.getElementById('houses-sprinklers').checked;
      const openingsInput = document.getElementById('houses-openings').value;
      const servesSingleSpace = document.getElementById('houses-serves-single-space').checked;
      const adjacentSpacesHeight = parseFloat(document.getElementById('houses-adjacent-spaces-height').value);
      const sameFloor = document.getElementById('houses-same-floor').checked;

      if (isNaN(facadeSurface) || isNaN(limitingDistance) || isNaN(adjacentSpacesHeight)) {
        document.getElementById('houses-result').innerText = "Erreur : Veuillez entrer des valeurs numériques valides.";
        return;
      }

      let openings;
      try {
        openings = JSON.parse(openingsInput);
        if (!Array.isArray(openings)) throw new Error("Les baies vitrées doivent être un tableau JSON.");
      } catch (e) {
        document.getElementById('houses-result').innerText = "Erreur : Format JSON invalide pour les baies vitrées.";
        return;
      }

      const result = handleHousesTab(
        facadeSurface,
        limitingDistance,
        hasSprinklers,
        openings,
        servesSingleSpace,
        adjacentSpacesHeight,
        sameFloor
      );
      let resultText = result.message;
      if (result.maxAreaPerOpening !== "Aucune restriction") {
        resultText += `\nSurface maximale par ouverture : ${result.maxAreaPerOpening} m².`;
      }
      if (result.errors) {
        resultText += "\nErreurs de conformité :\n" + result.errors.join("\n");
      } else {
        resultText += "\nLes baies vitrées sont conformes.";
      }
      document.getElementById('houses-result').innerText = resultText;
    }
  </script>
</body>
</html>
